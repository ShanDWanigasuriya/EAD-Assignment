@{
    ViewData["Title"] = "Stations";
}

<div class="card">
    <div class="card-header bg-dark text-white fw-bold">
        Station Management
    </div>
    <div class="card-body">
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success">@TempData["Success"]</div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger">@TempData["Error"]</div>
        }

        <!-- CREATE NEW STATION -->
        <form asp-action="Add" method="post" class="row g-2 mb-4 align-items-center">
            <div class="col"><input name="name" class="form-control" placeholder="Station Name" required /></div>
            <div class="col"><input name="location" class="form-control" placeholder='Location' required /></div>
            <div class="col">
                <select name="type" class="form-select" required>
                    <option value="">-- Type --</option>
                    <option value="AC">AC</option>
                    <option value="DC">DC</option>
                </select>
            </div>
            <div class="col"><input type="number" name="slots" min="1" class="form-control" placeholder="Slots" required /></div>
            <div class="col-auto"><button class="btn btn-primary">Add</button></div>
        </form>

        <!-- STATION TABLE -->
        <table class="table table-striped align-middle">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Location</th>
                    <th>Type</th>
                    <th>Slots</th>
                    <th>Status / Availability</th>
                    <th>Active Bookings</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var s in Model)
                {
                    bool isActive = Convert.ToBoolean(s["isActive"] ?? false);
                    int totalSlots = Convert.ToInt32(s["slots"] ?? 0);
                    int activeBookings = Convert.ToInt32(s["activeBookings"] ?? 0);
                    int availableNow = Convert.ToInt32(s["availableNow"] ?? totalSlots);

                    <tr>
                        <td>@s["id"]</td>

                        <td>
                            <input type="text" name="name" value="@s["name"]"
                                   class="form-control form-control-sm"
                                   form="form-@s["id"]" />
                        </td>

                        @* <td> <input type="text" name="location" value="@s["location"]" class="form-control form-control-sm" form="form-@s["id"]" /> </td> *@

                        <td>
                            <span>@s["displayLocation"]</span>
                            <input type="hidden" name="location" value="@s["location"]"
                                   form="form-@s["id"]" />
                        </td>


                        <td>
                            <select name="type" class="form-select form-select-sm"
                                    form="form-@s["id"]">
                                <option value="AC" selected="@(s["type"]?.ToString() == "AC")">AC</option>
                                <option value="DC" selected="@(s["type"]?.ToString() == "DC")">DC</option>
                            </select>
                        </td>

                        <td>@totalSlots</td>

                        <td>
                            @if (isActive)
                            {
                                <span class="badge bg-success">Active</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Inactive</span>
                            }

                            @if (availableNow == 0)
                            {
                                <span class="badge bg-danger ms-2">Full Capacity</span>
                            }
                            else
                            {
                                <span class="badge bg-info ms-2">
                                    @($"{availableNow}/{totalSlots} Slots Available")
                                </span>
                            }
                        </td>

                        <td>@activeBookings</td>

                        <td>
                            <div class="d-flex gap-1">
                                <!-- Update -->
                                <form id="form-@s["id"]" asp-action="Update" method="post" class="d-inline">
                                    <input type="hidden" name="id" value="@s["id"]" />
                                    <input type="hidden" name="slots" value="@totalSlots" />
                                    <button class="btn btn-success btn-sm">Update</button>
                                </form>

                                <!-- Activate / Deactivate -->
                                <form asp-action="ToggleStatus" method="post" class="d-inline">
                                    <input type="hidden" name="id" value="@s["id"]" />
                                    <button type="submit"
                                            name="isActive"
                                            value="@(isActive.ToString().ToLower())"
                                            class="btn btn-sm @(isActive ? "btn-outline-danger" : "btn-outline-success")">
                                        @(isActive ? "Deactivate" : "Activate")
                                    </button>
                                </form>


                                <!-- Delete (acts as soft delete = deactivate) -->
                                <form asp-action="Delete" method="post" class="d-inline">
                                    <input type="hidden" name="id" value="@s["id"]" />
                                    <button class="btn btn-danger btn-sm">Delete</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
